# Goals: ARMA modeling - estimation, diagnostics, forecasting.


# 0. SETUP DATA
rawdata <- c(35,34,34,34,26,21,12,0,-11,-19,-29,-39,-46,-53,-57,-56,-48,-40,-30,-24,-20,-18,-16,-13,-14,-15,-16,-21,-29,-38,-43,-51,-55,-56,-58,-59,-58,-51,-37,-30,-21,-13,-8,-1,14,28,38,48,53,51,49,47,45,44,42,37,28,26,23,23,22,23,22,22,15,14,14,17,19,21,21,17,10,3,-2,-3,1,8,11,17,22,29,36,41,45,46,49,48,45,42,37,27,12,-1,-15,-26,-37,-38,-46,-55,-61,-68,-66,-64,-55,-46,-33,-22,-16,-17,-20,-22,-33,-41,-47,-50,-54,-58,-57,-60,-58,-54,-47,-43,-37,-27,-19,-8,5,13,17,18,20,12,14,14,14,9,8,2,-3,-9,-10,-11,-12,-13,-7,5,15,28,34,30,25,17,3,-7,-11,-18,-26,-33,-41,-50,-56,-56,-61,-61,-61,-64,-65,-56,-45,-29,-14,2,10,9,7,8,5,6,5,4,1,-1,-3,-1,1,7,14,16,23,27,30,35,40,46,43,42,36,34,33,31,29,23,20,14,8,2,-4,-9,-19,-19,-17,-16,-12,-10,-6,-5,6,10,14,17,20,21,21,23,23,24,28,33,29,28,25,20,15,7,2,-7,-12,-15,-16,-21,-23,-25,-32,-37,-39,-40,-43,-40,-35,-28,-23,-14,-11,-9,-9,-5,-9,-15,-23,-29,-36,-41,-46,-54,-53,-52,-52,-52,-49,-47,-41,-35,-20,-13,-7,1,3,9,5,1,-16,-28,-42,-53,-58,-66,-66,-67,-64,-60,-57,-55,-51,-44,-34,-26,-13,-8,-8,-8,-8,-12,-18,-19,-29,-40,-46,-49,-54,-58,-63,-66,-73,-79,-82,-81,-74,-65,-52,-37,-20,-8,-1,3,7,4,0,-2,-2,-4,-7,-4,-9,-13,-15,-20,-23,-25,-20,-22,-20,-21,-21,-19,-16,-4,10,29,47,56,56,52,48,38,30,21,13,3,-7,-7,-19,-24,-28,-32,-38,-41,-37,-33,-28,-20,-12,-9,-8,-3,-2,3,7,15,16,20,19,23,25,31,38,44,51,52,49,42,38,30,21,12,-1,-11,-22,-26,-29,-32,-28,-23,-10,5,24,42,61,71,73,63,51,49,39,32,24,14,1,-8,-12,-16,-10,-4,2,5,9,13,19,30,41,50,53,58,60,61,61,66,63,58,55,48,44,37,37,39,36,40,41,40,38,39,41,44,50,49,51,52,61,65,66,64,58,49,45,48,52,52,51,46,32,18,7,-7,-18,-19,-18,-21,-18,-19,-20,-15,-8,-4,1,6,13,19,27,39,46,44,46,41,37,31,26,15,4,-2,-12,-18,-25,-28,-30,-39,-38,-40,-41,-38,-31,-18,-11,6,25,40,47,53,49,47,38,27,11,-6,-27,-41,-54,-62,-72,-83,-90,-89,-90,-83,-78,-75,-77,-77,-70,-66,-58,-49,-44,-41,-42,-40,-44,-44,-45,-51,-62,-67,-65,-60,-53,-38,-27,-17,-11,-5,-3,0,6,5,5,4,1,-4,-10,-8,-12,-22,-24,-27,-28,-21,-5,9,28,45,54,55,50,44,35,27,14,3,-9,-19,-25,-31,-35,-36,-38,-44,-50,-56,-53,-43,-25,-2,13,37,59,74,85,94,98,98,97,92,85,78,72,66,52,43,27,16,6,3,-3,-5,-6,-7,-13,-10,-3,7,21,34,38,41,42,44,45,39,34,24,9,-4,-13,-20,-21,-18,-12,-2,-1,6,9,8,11,10,9,8,8,4,1,-2,-8,-8,-8,-5,-10,-17,-27,-34,-35,-31,-16,-4,8,22,31,33,32,30,24,16,3,-7,-21,-32,-40,-49,-56,-61,-68,-72,-72,-72,-69,-61,-45,-31,-18,-8,-7,-10,-18,-21,-21,-16,-10,-16,-31,-44,-53,-62,-66,-68,-68,-66,-61,-50,-42,-28,-19,-18,-17,-18,-11,-13,-8,-6,-6,-8,-11,-14,-19,-21,-22,-17,-20,-13,-11,-10,-1,10,24,37,48,52,51,45,43,41,39,35,27,18,11,12,10,10,8,3,-1,-10,-7,-8,-10,-13,-18,-23,-26,-24,-24,-24,-23,-27,-28,-31,-24,-19,-10,-4,1,4,12,20,27,32,34,32,25,17,9,-1,-9,-12,-21,-26,-31,-33,-41,-39,-34,-27,-21,-8,2,13,19,29,37,39,45,43,38,34,29,23,11,4,-11,-18,-23,-20,-20,-21,-23,-24,-21,-15,-4,4,16,22,26,29,25,17,7,-4,-15,-28,-43,-56,-59,-59,-58,-53,-45,-38,-32,-22,-13,-4,-1,0,-10,-14,-17,-24,-26,-32,-37,-44,-45,-45,-49,-50,-44,-41,-39,-35,-30,-23,-16,-11,-8,-9,-7,-10,-10,-14,-17,-26,-34,-38,-38,-35,-33,-31,-31,-32,-27,-22,-10,-4,10,13,21,24,22,16,9,3,-4,-7,-8,-8,-10,-8,-4,-1,6,12,17,17,12,13,10,8,6,7,2,0,-4,-7,-6,-6,-8,-13,-11,-12,-15,-19,-16,-16,-22,-25,-26,-29,-22,-14,-4,-1,6,8,6,3,4,3,1,-3,-10,-15,-22,-18,-16,-10,-5,-4,-2,-4,2,5,11,12,8,-1,-8,-9,-13,-14,-15,-18,-28,-31,-35,-34,-30,-25,-20,-11,-4,5,15,21,33,43,46,51,49,41,33,26,16,4,-6,-18,-30,-41,-42,-41,-37,-27,-19,-10,5,23,42,56,66,64,52,47,38,24,15,2,-7,-18,-31,-38,-49,-55,-62,-68,-72,-68,-53,-40,-26,-14,-4,-12,-14,-19,-12,-6,1,2,-3,-5,-9,-10,-7,-1,4,4,4,2,2,4,8,19,16,17,6,-2,-8,-9,-9,-10,-8,-7,-10,-7,-2,0,5,17,24,24,26,34,36,42,45,41,34,25,19,12,6,3,-1,-4,-10,-12,-13,-3,5,9,-1,-21,-32,-38,-38,-32,-31,-34,-34,-34,-38,-37,-36,-35,-39,-35,-37,-41,-44,-45,-49,-53,-51,-47,-41,-29,-16,1,7,12,14,11,11,9,12,6,-2,-13,-28,-45,-54,-62,-64,-62,-59,-53,-47,-40,-33,-23,-8,3,13,18,24,26,24,26,21,13,3,1,-5,-5,-4,-3,1,5,6,13,15,18,17,6,2,-7,-14,-20,-28,-32,-36,-39,-39,-40,-38,-39,-42,-40,-38,-37,-32,-25,-10,3,16,28,37,38,36,28,13,-3,-20,-46,-70,-89,-96,-103,-101,-97,-90,-80,-69,-49,-36,-21,-10,1,4,11,18,16,18,14,11,6,-1,-5,-13,-16,-16,-14,-16,-15,-9,-10,-8,-8,-14,-14,-11,-5,6,17,25,29,32,30,24,13,1,-9,-24,-32,-35,-28,-22,-12,1,15,30,45,53,52,44,35,23,13,6,-9,-22,-35,-46,-57,-66,-71,-76,-79,-85,-92,-95,-90,-75,-58,-46,-32,-23,-20,-14,-10,-8,-11,-11,-10,-8,-8,-3,1,4,5,10,9,11,18,19,20,22,21,22,23,29,30,33,34,30,25,24,28,30,33,39,43,46,49,57,58,63,70,74,73,68,61,51,44,40,34,25,21,13,5,-3,-9,-11,-9,-4,-2,5,13,23,34,34,38,34,29,25,22,18,12,13,9,7,1,2,3,1,0,-4,-6,-9,-7,-6,-11,-13,-19,-25,-30,-31,-29,-29,-20,-16,-6,3,16,28,38,41,42,37,32,23,4,-9,-27,-41,-52,-60,-57,-56,-50,-45,-40,-35,-23,-2,17,38,55,67,70,73,68,58,50,38,25,4,-15,-35,-50,-63,-67,-69,-69,-64,-60,-54,-48,-41,-35,-31,-23,-25,-34,-46,-64,-77,-90,-98,-107,-115,-118,-115,-112,-106,-97,-84,-72,-55,-33,-14,2,20,30,35,42,48,45,43,39,31,21,11,6,0,-2,-5,-4,-6,-5,-3,-2,6,17,29,34,39,41,39,35,31,26,21,18,13,3,-11,-25,-46,-63,-76,-82,-84,-84,-83,-87,-82,-73,-58,-42,-26,-15,-5,5,12,18,23,24,31,33,29,27,21,14,6,-4,-11,-9,-3,2,5,7,8,8,8,11,15,12,12,4,-1,-9,-16,-24,-33,-34,-41,-43,-34,-19,1,17,31,39,42,41,42,40,37,33,24,17,9,6,0,-8,-9,-8,-6,4,17,25,30,36,41,42,44,53,65,80,94,104,100,92,84,70,59,45,31,17,5,-1,-2,-1,0,-1,-10,-16,-21,-24,-24,-18,-15,-17,-19,-28,-37,-41,-39,-29,-25,-14,-13,-4,2,10,22,30,37,42,42,40,40,37,28,22,7,0,-8,-11,-13,-11,-6,4,10,16,24,32,40,47,56,61,67,72,71,71,69,67,58,56,57,53,52,44,36,21,11,6,7,13,22,28,28,32,32,28,29,31,32,33,35,36,38,43,47,47,44,45,42,39,36,37,38,37,40,38,34,30,27,26,21,18,12,4,0,-1,-7,-9,-11,-16,-23,-21,-13,-9,-4,-5,-7,-17,-24,-28,-32,-30,-25,-20,-22,-22,-26,-29,-33,-28,-29,-32,-34,-40,-46,-43,-32,-19,-5,11,22,29,39,46,49,49,45,39,30,21,16,14,13,20,17,17,11,13,14,17,17,21,22,26,36,41,45,42,31,19,12,9,0,-6,-15,-25,-33,-43,-47,-51,-47,-38,-35,-32,-27,-25,-27,-23,-24,-27,-37,-41,-42,-43,-41,-36,-27,-23,-20,-20,-23,-24,-21,-22,-25,-25,-26,-28,-31,-28,-32,-40,-38,-42,-41,-43,-35,-36,-29,-25,-22,-18,-15,-7,-7,-1,0,-5,-6,-10,-14,-23,-32,-40,-48,-59,-65,-68,-75,-74,-71,-67,-61,-55,-40,-27,-10,5,16,22,23,19,9,1,-7,-21,-38,-45,-51,-54,-55,-54,-56,-56,-59,-62,-70,-76,-73,-72,-72,-62,-54,-45,-38,-27,-27,-25,-21,-26,-28,-35,-38,-41,-45,-46,-49,-52,-49,-44,-42,-31,-23,-18,-13,-7,0,-2,-2,-1,0,0,3,8,10,12,15,15,18,22,25,28,28,29,28,21,14,3,-5,-12,-12,-17,-26,-30,-32,-31,-33,-28,-27,-25,-18,-12,-5,3,18,30,43,52,55,53,49,49,41,40,37,35,31,24,21,10,5,2,-2,-4,-1,11,23,36,46,50,49,41,37,25,19,11,2,-8,-18,-26,-31,-29,-24,-14,-12,-6,-5,-5,-9,-7,-2,1,-1,-5,-6,-6,-5,-5,-11,-14,-20,-34,-51,-72,-89,-99,-107,-114,-124,-129,-128,-128,-122,-116,-103,-87,-71,-55,-48,-36,-34,-32,-33,-33,-28,-27,-19,-11,-8,-13,-21,-26,-29,-30,-28,-22,-20,-20,-15,-13,-8,-2,2,2,2,5,4,4,9,7,0,-4,-12,-21,-28,-29,-29,-29,-24,-15,-11,-6,0,2,2,-2,-1,-8,-13,-17,-25,-25,-22,-18,-17,-17,-17,-23,-21,-20,-15,-10,-4,1,5,13,19,20,26,26,30,33,43,50,55,52,43,36,26,14,9,3,-6,-14,-17,-13,-4,10,18,22,25,26,28,25,27,21,18,18,17,14,12,12,7,3,1,1,1,3,10,10,11,12,12,10,7,14,18,26,31,37,34,31,28,22,18,17,12,5,2,4,2,2,-4,-7,-12,-15,-17,-15,-8,1,14,32,36,40,34,28,30,29,17,9,7,6,4,-4,-19,-35,-41,-39,-33,-22,-10,-4,-5,-5,-8,-16,-22,-21,-21,-19,-20,-21,-24,-26,-25,-29,-36,-39,-42,-42,-37,-27,-20,-9,-1,9,13,19,22,19,16,16,15,9,7,3,-3,-8,-10,-13,-7,0,8,13,16,17,17,10,8,4,-1,-3,-11,-14,-24,-31,-34,-37,-35,-27,-23,-18,-16,-19,-25,-30,-31,-26,-26,-27,-30,-35,-33,-21,-9,3,16,21,20,19,20,17,19,23,20,12,2,-1,-7,-4,-2,5,10,11,13,20,23,33,42,48,54,58,54,50,45,45,38,40,39,35,28,27,23,16,8,0,-4,-1,4,11,12,24,33,39,49,54,58,60,60,56,47,39,28,22,21,25,28,24,22,18,14,15,17,17,16,22,29,33,37,38,41,41,39,36,31,25,23,14,12,9,8,4,2,1,-1,-9,-12,-10,-7,-3,6,15,20,20,17,8,-2,-11,-21,-31,-36,-37,-37,-29,-20,-6,0,5,6,5,3,3,4,1,1,1,-2,-7,-10,-17,-13,-11,-7,-6,-4,-1,-6,-7,-13,-16,-22,-21,-23,-24,-27,-23,-21,-18,-15,-12,-10,-9,-6,-7,-14,-16,-25,-30,-36,-36,-37,-38,-42,-45,-44,-43,-40,-46,-51,-52,-52,-51,-42,-33,-26,-24,-22,-21,-22,-22,-20,-23,-24,-23,-27,-32,-34,-35,-31,-27,-21,-16,-15,-14,-8,-9,-5,-5,-4,-8,-12,-16,-22,-26,-32,-37,-48,-50,-51,-49,-45,-34,-32,-35,-37,-36,-31,-26,-18,-11,-3,-2,-9,-15,-22,-24,-22,-29,-27,-30,-31,-29,-24,-17,-19,-18,-19,-20,-21,-18,-19,-17,-10,-7,-9,-11,-9,-12,-14,-9,-9,-15,-19,-21,-31,-31,-27,-22,-21,-19,-14,-10,-6,0,1,-1,-4,-7,-13,-13,-9,-3,-2,0,-1,0,-4,-4,-2,-7,-11,-14,-17,-21,-13,-15,-11,-10,-14,-18,-23,-24,-22,-21,-13,-6,-5,-1,0,3,0,-7,-17,-27,-35,-38,-45,-51,-53,-56,-59,-60,-59,-64,-57,-52,-43,-39,-37,-33,-35,-34,-29,-22,-24,-26,-31,-46,-69,-87,-102,-112,-117,-122,-123,-120,-113,-110,-105,-96,-86,-76,-67,-53,-43,-35,-28,-32,-36,-42,-41,-38,-35,-28,-26,-20,-19,-19,-22,-22,-22,-23,-27,-29,-27,-27,-21,-15,-12,-12,-16,-14,-15,-15,-18,-20,-20,-23,-24,-32,-41,-43,-39,-39,-35,-28,-25,-11,3,18,23,28,30,26,27,29,28,21,18,11,2,-11,-23,-40,-61,-76,-92,-103,-108,-103,-97,-91,-83,-78,-75,-71,-63,-55,-52,-47,-45,-46,-45,-45,-50,-59,-67,-73,-75,-71,-64,-59,-51,-42,-38,-41,-40,-36,-29,-20,-7,3,15,28,39,42,46,47,46,44,42,41,38,38,44,46,45,48,47,46,45,55,62,68,75,75,75,77,81,85,82,81,77,72,71,70,69,63,60,55,53,52,62,65,73,78,82,80,81,82,81,78,74,67,58,54,60,65,71,74,72,68,62,64,64,68,74,77,74,71,70,69,67,67,64,58,53,48,40,36,32,31,27,21,16,8,6,13,20,31,41,49,55,60,67,67,63,60,51,37,24,10,0,-4,-6,-11,-19,-23,-24,-29,-33,-33,-35,-36,-35,-33,-36,-40,-42,-48,-51,-52,-47,-46,-46,-46,-50,-54,-57,-54,-55,-50,-44,-43,-38,-37,-30,-34,-34,-37,-34,-39,-35,-28,-23,-16,-6,2,8,14,17,26,33,39,41,40,38,36,27,23,16,9,0,-8,-20,-29,-37,-39,-41,-41,-40,-41,-43,-43,-34,-32,-27,-23,-16,-10,-6,1,1,7,16,20,21,22,21,16,7,-1,-2,-1,9,18,22,30,36,41,41,41,45,50,59,65,70,75,79,82,80,80,83,84,79,73,61,46,39,36,35,30,27,17,4,-12,-24,-30,-28,-15,-5,8,21,35,49,61,73,78,77,70,62,46,34,20,6,-12,-28,-43,-59,-70,-74,-76,-80,-82,-87,-89,-87,-79,-69,-64,-52,-47,-43,-41,-37,-40,-46,-46,-50,-51,-53,-51,-45,-48,-40,-41,-44,-43,-42,-38,-37,-31,-31,-31,-32,-33,-30,-29,-25,-26,-25,-22,-16,-10,-4,2,5,3,2,-1,-5,-7,-7,-6,-10,-7,-11,-9,-14,-10,-8,-8,-2,1,7,12,23,31,37,45,43,43,40,3)

# Make a R timeseries out of the rawdata: specify frequency & startdate
gIIP <- ts(rawdata, frequency=12, start=c(1991,4))
print(gIIP)
plot.ts(gIIP, type="l", col="blue", ylab="IIP Growth (%)", lwd=2,
        main="Full data")
grid()

# Based on this, I decide that 4/1995 is the start of the sensible period.
gIIP <- window(gIIP, start=c(1995,4))
print(gIIP)
plot.ts(gIIP, type="l", col="blue", ylab="IIP Growth (%)", lwd=2,
        main="Estimation subset")
grid()

# Descriptive statistics about gIIP
mean(gIIP); sd(gIIP); summary(gIIP);
plot(density(gIIP), col="blue", main="(Unconditional) Density of IIP growth")
acf(gIIP)


# 1. ARMA ESTIMATION
m.ar2 <- arima(gIIP, order = c(2,0,0))
print(m.ar2)                       # Print it out


# 2. ARMA DIAGNOSTICS
tsdiag(m.ar2)                      # His pretty picture of diagnostics
## Time series structure in errors
print(Box.test(m.ar2$residuals, lag=12, type="Ljung-Box"));
## Sniff for ARCH
print(Box.test(m.ar2$residuals^2, lag=12, type="Ljung-Box"));
## Eyeball distribution of residuals
plot(density(m.ar2$residuals), col="blue", xlim=c(-8,8),
     main=paste("Residuals of AR(2)"))


# 3. FORECASTING
## Make a picture of the residuals
plot.ts(m.ar2$residual, ylab="Innovations", col="blue", lwd=2)
s <- sqrt(m.ar2$sigma2)
abline(h=c(-s,s), lwd=2, col="lightGray")

p <- predict(m.ar2, n.ahead = 12)         # Make 12 predictions.
print(p)

## Watch the forecastability decay away from fat values to 0.
## sd(x) is the naive sigma. p$se is the prediction se.
gain <- 100*(1-p$se/sd(gIIP))
plot.ts(gain, main="Gain in forecast s.d.", ylab="Per cent",
        col="blue", lwd=2)

## Make a pretty picture that puts it all together
ts.plot(gIIP, p$pred, p$pred-1.96*p$se, p$pred+1.96*p$se,
        gpars=list(lty=c(1,1,2,2), lwd=c(2,2,1,1),
          ylab="IIP growth (%)", col=c("blue","red", "red", "red")))
grid()
abline(h=mean(gIIP), lty=2, lwd=2, col="lightGray")
legend(x="bottomleft", cex=0.8, bty="n",
       lty=c(1,1,2,2), lwd=c(2,1,1,2),
       col=c("blue", "red", "red", "lightGray"),
       legend=c("IIP", "AR(2) forecasts", "95% C.I.", "Mean IIP growth"))
